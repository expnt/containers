VERSION 0.8

ARG BASE_VERSION
ARG GITHUB_REPOSITORY_OWNER
ARG POETRY_VERSION
ARG PRECOMMIT_VERSION
ARG OPENTOFU_VERSION
ARG TFLINT_VERSION

python-base:
    ARG BASE_VERSION
    FROM python:${BASE_VERSION}-bookworm

validate:
    FROM +python-base
    ARG BASE_VERSION
    RUN --no-cache test -n "$BASE_VERSION" || (echo "BASE_VERSION is required" && exit 1)

build:
    BUILD +validate
    FROM +python-base
    USER root
    ARG BASE_VERSION
    ARG GITHUB_REPOSITORY_OWNER
    ARG POETRY_VERSION
    ARG PRECOMMIT_VERSION
    ARG OPENTOFU_VERSION
    ARG TFLINT_VERSION
    RUN GITHUB_REPOSITORY_OWNER=$(echo "$GITHUB_REPOSITORY_OWNER" | tr '[:upper:]' '[:lower:]' | tr -d '/' | sed 's/_/-/g')
    
    RUN set -eux && \
        apt-get update && \
        apt-get install -y --no-install-recommends \
            curl \
            ca-certificates \
            gnupg \
            lsb-release \
            unzip && \
        apt-get install -y --no-install-recommends pipx && \
        pipx install poetry==${POETRY_VERSION} && \
        pipx install pre-commit==${PRECOMMIT_VERSION} && \
        ARCH=$(dpkg --print-architecture) && \
        curl --http1.1 -fsSL -o /tmp/opentofu.deb \
            https://github.com/opentofu/opentofu/releases/download/v${OPENTOFU_VERSION}/tofu_${OPENTOFU_VERSION}_${ARCH}.deb && \
        dpkg -i /tmp/opentofu.deb && \
        curl --http1.1 -fsSL -o /tmp/tflint.zip \
            https://github.com/terraform-linters/tflint/releases/download/v${TFLINT_VERSION}/tflint_linux_${ARCH}.zip && \
        unzip /tmp/tflint.zip -d /usr/local/bin && \
        chmod +x /usr/local/bin/tflint && \
        apt-get purge -y curl gnupg lsb-release unzip && \
        apt-get clean && \
        apt-get autoremove -y && \
        rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /var/cache/apt/* \
               /usr/share/doc/* /usr/share/man/* /usr/share/info/* \
               /usr/share/i18n/locales/* /usr/share/locale/* && \
        (find /usr/share/i18n -type f ! -name "POSIX" -delete || true)
    
    ENV PATH="/root/.local/bin:$PATH"
    
    SAVE IMAGE --push ghcr.io/${GITHUB_REPOSITORY_OWNER}/xep-python-iac:${BASE_VERSION}-bookworm
    SAVE IMAGE xep-python-iac:${BASE_VERSION}-bookworm

build-multiplatform:
    BUILD --platform=linux/amd64 --platform=linux/arm64 +build

