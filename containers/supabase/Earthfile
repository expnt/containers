VERSION 0.8

ARG BASE_VERSION 
ARG PLUGIN_VERSION
ARG PLUGIN_VERSION_TAG
ARG PG_MAJOR
ARG GITHUB_REPOSITORY_OWNER

supabase-base:
    ARG BASE_VERSION
    FROM supabase/postgres:$BASE_VERSION

validate:
    FROM +supabase-base
    ARG BASE_VERSION
    ARG PLUGIN_VERSION
    ARG PG_MAJOR
    RUN --no-cache test -n "$BASE_VERSION" || (echo "BASE_VERSION is required" && exit 1)
    RUN --no-cache test -n "$PLUGIN_VERSION" || (echo "PLUGIN_VERSION is required" && exit 1)
    RUN --no-cache test -n "$PG_MAJOR" || (echo "PG_MAJOR is required" && exit 1)

build:
    BUILD +validate
    FROM +supabase-base
    USER root
    
    ARG BASE_VERSION
    ARG PLUGIN_VERSION
    ARG PLUGIN_VERSION_TAG
    ARG PG_MAJOR
    ARG GITHUB_REPOSITORY_OWNER
    
    RUN GITHUB_REPOSITORY_OWNER=$(echo "$GITHUB_REPOSITORY_OWNER" | tr '[:upper:]' '[:lower:]' | tr -d '/' | sed 's/_/-/g')

    RUN set -xe && \
        apt-get update && \
        apt-get install -y --no-install-recommends postgresql-common ca-certificates gnupg lsb-release curl && \
        DISTRO=$(lsb_release -cs) && \
        echo "deb https://apt.postgresql.org/pub/repos/apt ${DISTRO}-pgdg main" > /etc/apt/sources.list.d/pgdg.list && \
        curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg && \
        apt-get update -o Acquire::https::Verify-Peer=false -o Acquire::https::Verify-Host=false && \
        apt-get install -y --no-install-recommends postgresql-${PG_MAJOR}-pg-failover-slots || \
        (echo "Warning: postgresql-${PG_MAJOR}-pg-failover-slots not found in repository, skipping installation" && true) && \
        apt-get purge -y curl gnupg lsb-release && \
        apt-get clean && \
        apt-get autoremove -y && \
        rm -rf /etc/apt/sources.list.d/pgdg.list /etc/apt/trusted.gpg.d/postgresql.gpg \
               /var/lib/apt/lists/* /tmp/* /var/tmp/* /var/cache/apt/* \
               /usr/share/doc/* /usr/share/man/* /usr/share/info/* \
               /usr/share/i18n/locales/* /usr/share/locale/* \
               /usr/share/mecab/* /usr/share/lintian/* /usr/share/common-licenses/* && \
        find /usr/share/i18n -type f ! -name "POSIX" -delete && \
        mkdir -p /etc/postgresql-custom /var/run/postgresql && \
        chmod 777 /var/run/postgresql && \
        chmod 777 /etc/postgresql-custom && \
        find /usr -name "*.a" -delete && \
        find /usr -name "*.la" -delete

    USER postgres
    EXPOSE 5432

    SAVE IMAGE --push ghcr.io/${GITHUB_REPOSITORY_OWNER}/supabase:${PG_MAJOR}-plugin-${PLUGIN_VERSION_TAG}
    SAVE IMAGE supabase:${PG_MAJOR}-plugin-${PLUGIN_VERSION_TAG}

build-multiplatform:
    BUILD --platform=linux/amd64 --platform=linux/arm64 +build
