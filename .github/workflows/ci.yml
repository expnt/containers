# .github/workflows/ci.yml

name: Build and Release

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Add default permissions at the workflow level
permissions:
  contents: write
  packages: write
  pull-requests: write
  issues: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION | grep '^version:' | cut -d' ' -f2)
          POSTGRES_VERSION=$(cat VERSION | grep '^postgresql:' | cut -d' ' -f2)
          TIMESCALE_VERSION=$(cat VERSION | grep '^timescaledb:' | cut -d' ' -f2)
          PG_VERSION=$(cat VERSION | grep '^postgresql:' | cut -d' ' -f2 | cut -d'-' -f1)
          PG_MAJOR=$(cat VERSION | grep '^postgresql:' | cut -d' ' -f2 | cut -d'.' -f1)
          CLOUDNATIVEPG_VERSION=$(cat VERSION | grep '^cloudnativepg:' | cut -d' ' -f2 | tr -d '\r\n' | sed 's/-/./g')
          
          if [[ -z "$VERSION" || -z "$POSTGRES_VERSION" || -z "$TIMESCALE_VERSION" || -z "$CLOUDNATIVEPG_VERSION" ]]; then
            echo "Error: Missing required version information in VERSION file"
            exit 1
          fi
          
          if ! [[ "$CLOUDNATIVEPG_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid CloudNativePG version format: $CLOUDNATIVEPG_VERSION"
            exit 1
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "POSTGRES_VERSION=$POSTGRES_VERSION" >> $GITHUB_OUTPUT
          echo "TIMESCALE_VERSION=$TIMESCALE_VERSION" >> $GITHUB_OUTPUT
          echo "PG_VERSION=$PG_VERSION" >> $GITHUB_OUTPUT
          echo "PG_MAJOR=$PG_MAJOR" >> $GITHUB_OUTPUT
          echo "CLOUDNATIVEPG_VERSION=$CLOUDNATIVEPG_VERSION" >> $GITHUB_OUTPUT

      - name: Install Earthly
        run: |
          sudo /bin/sh -c 'wget https://github.com/earthly/earthly/releases/download/v0.8.13/earthly-linux-amd64 -O /usr/local/bin/earthly && chmod +x /usr/local/bin/earthly'

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run semantic-release
        id: semrel
        uses: cycjimmy/semantic-release-action@v4
        with:
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
            @semantic-release/exec
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tags
        id: tags
        run: |
          # For PRs, use PR number as tag
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "tag=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          # For main branch, use semantic version
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            if [[ -n "${{ steps.semrel.outputs.released }}" ]]; then
              echo "tag=v${{ steps.semrel.outputs.version }}" >> $GITHUB_OUTPUT
            else
              echo "tag=latest" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Build and push Docker images
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          BASE_REPO="${{ github.event.repository.name }}"
          TIMESCALE_REPO="${BASE_REPO}-timescale"
          SUPABASE_REPO="${BASE_REPO}-supabase"
          TAG=${{ steps.tags.outputs.tag }}
          GIT_SHA=$(git rev-parse --short HEAD)
          VERSION=${{ steps.version.outputs.VERSION }}
          POSTGRES_VERSION=${{ steps.version.outputs.POSTGRES_VERSION }}
          TIMESCALE_VERSION=${{ steps.version.outputs.TIMESCALE_VERSION }}
          PG_VERSION=${{ steps.version.outputs.PG_VERSION }}
          PG_MAJOR=${{ steps.version.outputs.PG_MAJOR }}
          CLOUDNATIVEPG_VERSION=${{ steps.version.outputs.CLOUDNATIVEPG_VERSION }}
          
          # Build TimescaleDB image
          echo "Building TimescaleDB image: $TIMESCALE_REPO:$TAG"
          echo "Using CloudNativePG version: $CLOUDNATIVEPG_VERSION"
          earthly --ci --push +timescale-build \
            --DOCKER_IMAGE_TIMESCALE=ghcr.io/$REPO_OWNER/$TIMESCALE_REPO:$TAG \
            --VERSION=$VERSION \
            --GIT_SHA=$GIT_SHA \
            --POSTGRES_VERSION=$POSTGRES_VERSION \
            --TIMESCALE_VERSION=$TIMESCALE_VERSION \
            --PG_VERSION=$PG_VERSION \
            --PG_MAJOR=$PG_MAJOR \
            --CLOUDNATIVEPG_VERSION="$CLOUDNATIVEPG_VERSION"
          
          # Build Supabase image
          echo "Building Supabase image: $SUPABASE_REPO:$TAG"
          earthly --ci --push +supabase-build \
            --DOCKER_IMAGE_SUPABASE=ghcr.io/$REPO_OWNER/$SUPABASE_REPO:$TAG \
            --VERSION=$VERSION \
            --GIT_SHA=$GIT_SHA \
            --POSTGRES_VERSION=$POSTGRES_VERSION \
            --PG_VERSION=$PG_VERSION \
            --PG_MAJOR=$PG_MAJOR \
            --CLOUDNATIVEPG_VERSION="$CLOUDNATIVEPG_VERSION"

          # If this is a release, also tag as latest
          if [[ "${{ steps.semrel.outputs.released }}" == "true" ]]; then
            # Tag TimescaleDB image as latest
            docker pull ghcr.io/$REPO_OWNER/$TIMESCALE_REPO:$TAG
            docker tag ghcr.io/$REPO_OWNER/$TIMESCALE_REPO:$TAG ghcr.io/$REPO_OWNER/$TIMESCALE_REPO:latest
            docker push ghcr.io/$REPO_OWNER/$TIMESCALE_REPO:latest
            
            # Tag Supabase image as latest
            docker pull ghcr.io/$REPO_OWNER/$SUPABASE_REPO:$TAG
            docker tag ghcr.io/$REPO_OWNER/$SUPABASE_REPO:$TAG ghcr.io/$REPO_OWNER/$SUPABASE_REPO:latest
            docker push ghcr.io/$REPO_OWNER/$SUPABASE_REPO:latest
          fi





